# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.ibm.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

env:
  PACT_BROKER_TOKEN: ${{ secrets.PACT_BROKER_TOKEN }}
  IBMCLOUD_APIKEY: ${{ secrets.IBMCLOUD_APIKEY }}
  REGISTRY_SECRET: ${{ secrets.REGISTRY_SECRET }}
  APP_HOST: ${{ vars.APP_HOST }}
  OKTETO_TOKEN: ${{ secrets.OKTETO_TOKEN }}
  REGISTRY: registry.cloud.okteto.net

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  commitlint:
    name: Verify commits are linted
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          fetch-depth: 0
      - uses: wagoid/commitlint-github-action@master

  hadolint:
    name: Verify dockerfile is linted
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - uses: hadolint/hadolint-action@master
        with:
          dockerfile: Dockerfile

  eslint-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@master
      - name: Use Node.js 18.16.0
        uses: actions/checkout@master
      - run: npm ci
      - run: npm run lint:verify

  inspec:
    name: Unit test docker image
    needs: [hadolint]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@master

      - name: Install Inspec
        run: curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec

      - name: Run Inspec tests
        run: inspec exec test/container/unit/*.rb --chef-license accept

  prettier-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@master
      - name: Use Node.js 18.16.0
        uses: actions/checkout@master
      - run: npm ci
      - run: npm run prettier:verify

  detect-secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@master
      - name: Use Node.js 18.16.0
        uses: actions/checkout@master
      - run: npm ci
      - run: npm run detect-secrets $(git ls-files)

  snyk_test:
    runs-on: ubuntu-latest
    needs: [eslint-verify, prettier-verify]

    steps:
      - uses: actions/checkout@master
      - name: Use Node.js 18.16.0
        uses: snyk/actions/node@master
        env:
          # In order to use the Snyk Action you will need to have a Snyk API token.
          # More details in https://{{cookiecutter.github_url}}/snyk/actions#getting-your-snyk-token
          # or you can signup for free at https://snyk.io/login
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

  test_and_coverage:
    runs-on: ubuntu-latest
    needs: [eslint-verify, prettier-verify, hadolint]

    steps:
      - uses: actions/checkout@master
      - uses: actions/setup-node@master
      - name: Install Inspec
        run: curl https://omnitruck.chef.io/install.sh | sudo bash -s -- -P inspec
      - name: Use Node.js 18.16.0
        uses: warchant/setup-sonar-scanner@master
        with:
          node-version: 18.16.0
      - run: touch .env
      - run: npm ci
      - run: npm test
      - run: sonar-scanner
          -Dsonar.login=${{ secrets.SONAR_TOKEN }}

  pact_test:
    runs-on: ubuntu-latest
    needs: [eslint-verify, prettier-verify]

    steps:
      - uses: actions/setup-node@master
      - name: Run Pact tests
        uses: actions/checkout@master
      - run: touch .env
      - run: npm ci
      - run: npm run test:api:consumer
      - run: npm run publish:pact
      - run: export CI=true && npm run test:api:provider

  build_image:
    runs-on: ubuntu-latest
    needs:
      [
        pact_test,
        test_and_coverage,
        detect-secrets,
        commitlint,
        snyk_test,
        inspec,
      ]
    steps:
      - name: Check out the repo
        uses: actions/checkout@master

      - name: Log in to Docker Hub
        uses: docker/login-action@master
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@master
        with:
          images: ${{ env.REGISTRY }}/gotreasa/gotreasa-berlin-clock

      - name: Build and push Docker image
        uses: docker/build-push-action@master
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Output the details of outputs
        run: echo "The tags ${{ steps.meta.outputs.tags }}" && echo "The labels ${{ steps.meta.outputs.labels }}"

      - name: Run tests on the docker container structure
        uses: plexsystems/container-structure-test-action@main
        with:
          image: ${{ steps.meta.outputs.tags }}
          config: test/container/structure/config.yaml

  deploy_image:
    runs-on: ubuntu-latest
    needs: [build_image]
    steps:
      - uses: actions/checkout@master

      - uses: okteto/context@latest
        with:
          token: ${{ secrets.OKTETO_TOKEN }}

      - name: 'Activate Namespace'
        uses: okteto/namespace@latest
        with:
          namespace: gotreasa

      - name: 'Create stack'
        uses: okteto/deploy-stack@latest
        with:
          build: 'false'

  smoke_test:
    runs-on: ubuntu-latest
    needs: [deploy_image]
    steps:
      - uses: actions/setup-node@master
      - name: Smoke test using pact tests
        uses: actions/checkout@master
      - run: touch .env
      - run: npm ci
      - run: export SMOKE_TEST=true && npm run test:api:provider -- --collectCoverage=false

  goss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - uses: actions/setup-go@v2
      - name: Install Goss action
        uses: e1himself/goss-installation-action@v1
        with:
          version: 'v0.3.20'
      - name: Validate the server is running correctly
        run: goss validate --gossfile test/container/integration/goss.yaml

  snyk_monitor:
    runs-on: ubuntu-latest
    needs: [deploy_image]

    steps:
      - uses: actions/checkout@master
      - name: Use Node.js 18.16.0
        uses: snyk/actions/node@master
        env:
          # In order to use the Snyk Action you will need to have a Snyk API token.
          # More details in https://{{cookiecutter.github_url}}/snyk/actions#getting-your-snyk-token
          # or you can signup for free at https://snyk.io/login
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
